#!/usr/bin/env amm

import ammonite.ops._
import ammonite.ops.ImplicitWd._

import $file.phabricator
import $file.provision

@main
def compileAndTest(): Unit = {
  %('sbt, 'clean, 'test, "integration:test", 'scapegoat)
}

/**
 * The pipeline target for Phabricator builds. It triggers the Jenkins target
 * and does some additional reporting to Phabricator.
 */
@main
def phabricator(): Unit = {
  jenkins()
}

/**
 * The main pipeline target for builds on Jekins.
 */
@main
def jenkins(): Unit = {
  provision.killStaleTestProcesses()
  provision.installMesos()

  compileAndTest()

  phabricator.reportSuccess()
}
